trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:

- task: AzureCLI@2
  inputs:
    azureSubscription: 'KubeSC'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      docker build -t faroprodregistry.azurecr.io/web-game:latest 2048-game
      az acr login -n faroprodregistry
      docker push faroprodregistry.azurecr.io/web-game:latest

- script: cat 01_kubernetes_aks/app-deploy.yaml

- task: KubernetesManifest@1
  inputs:
    action: 'deploy'
    connectionType: 'azureResourceManager'
    azureSubscriptionConnection: 'Azure for Students (e16a284c-ba7a-4e2f-affa-78fdea4cd5dc)'
    azureResourceGroup: 'Kube-ProdRg'
    kubernetesCluster: 'faroprodcluster'
    useClusterAdmin: true
    namespace: 'default'
    manifests: |
      '$(Pipeline.Workspace)/manifests/deployment.yml'
      '$(Pipeline.Workspace)/manifests/service.yml'